<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Alunos</title>
    <style> body{font-family:Arial;margin:30px} input{padding:6px} table{border-collapse:collapse} th,td{border:1px solid #ccc;padding:8px}</style>
</head>
<body>
    <h2>Alunos</h2>

    <form id="formAluno">
        <input id="nome" placeholder="Nome" required>
        <input id="idade" type="number" placeholder="Idade" required>
        <input id="turma_id" type="number" placeholder="ID Turma" required>
        <button type="submit">Cadastrar</button>
    </form>

    <hr>

    <table>
        <thead><tr><th>ID</th><th>Nome</th><th>Idade</th><th>Turma</th><th>Ações</th></tr></thead>
        <tbody id="tbody"></tbody>
    </table>

<script>
const API = "/alunos/api";

async function listar(){
    const res = await fetch(API);
    const dados = await res.json();
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    dados.forEach(a=>{
        tbody.innerHTML += `<tr>
            <td>${a.id}</td>
            <td>${a.nome}</td>
            <td>${a.idade ?? ''}</td>
            <td>${a.turma_id ?? ''}</td>
            <td>
                <button onclick="editar(${a.id},'${(a.nome||'').replace(/'/g,"\\'")}',${a.idade||''},${a.turma_id||''})">Editar</button>
                <button onclick="deletar(${a.id})" style="background:red;color:#fff">Excluir</button>
            </td>
        </tr>`;
    });
}

document.getElementById("formAluno").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const payload = {
        nome: document.getElementById("nome").value,
        idade: parseInt(document.getElementById("idade").value),
        turma_id: parseInt(document.getElementById("turma_id").value)
    };
    await fetch(API, { method: "POST", headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    e.target.reset();
    listar();
});

async function deletar(id){
    if(!confirm("Excluir aluno?")) return;
    await fetch(`${API}/${id}`, { method: "DELETE" });
    listar();
}

async function editar(id, nome, idade, turma_id){
    const novoNome = prompt("Nome:", nome) || nome;
    const novaIdade = prompt("Idade:", idade) || idade;
    const novaTurma = prompt("Turma ID:", turma_id) || turma_id;
    await fetch(`${API}/${id}`, {
        method: "PUT",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ nome: novoNome, idade: parseInt(novaIdade), turma_id: parseInt(novaTurma) })
    });
    listar();
}

listar();
</script>
</body>
</html>
